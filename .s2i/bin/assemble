#!/bin/sh

S2I_DESTINATION=${S2I_DESTINATION:-/tmp}
S2I_SOURCE_DIR="${S2I_DESTINATION}/src"
DEPLOYMENTS_DIR="${DEPLOYMENTS_DIR:-/deployments}"

if [ -z "${SUBPROJECT_DIR}" ]; then
    echo "Please specify which subproject directory to build with SUBPROJECT_DIR" >&2
    exit 1
fi

if [ ! -d "${S2I_SOURCE_DIR}/${SUBPROJECT_DIR}" ]; then
    echo "Subproject directory \"${S2I_SOURCE_DIR}/${SUBPROJECT_DIR}\" does not exist" >&2
    exit 1
fi
cd "${S2I_SOURCE_DIR}/${SUBPROJECT_DIR}"

if [ -f "src/main/resources/application.properties" ]; then
    sed -i "s|RobotMakerService/mp-rest/url=.*|RobotMakerService/mp-rest/url=${ROBOTMAKER_URL}|" \
        "src/main/resources/application.properties"
fi

echo "Running ./gradlew --no-daemon build"
./gradlew --no-daemon build
if [ $? -ne 0 ]; then
    echo "Grade build failed" >&2
    exit 1
fi

echo "Copying artifacts"
mkdir -p "${DEPLOYMENTS_DIR}"
cp -v -p -r build/lib/ build/*-runner.jar "${DEPLOYMENTS_DIR}"
if [ $? -ne 0 ]; then
    echo "Failed to copy artifacts to \"${DEPLOYMENTS_DIR}\"" >&2
    exit 1
fi
